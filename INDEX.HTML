<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wellness Journal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0d1117; }
        .card { background-color: #161b22; }
        /* Custom styles for the mood buttons */
        .mood-btn {
            transition: all 0.2s;
            filter: grayscale(0.5);
        }
        .mood-btn:hover {
            transform: scale(1.05);
            filter: grayscale(0);
        }
        .mood-btn.selected {
            transform: scale(1.1);
            filter: grayscale(0);
            box-shadow: 0 0 15px rgba(100, 255, 218, 0.7);
        }
        /* Custom styles for the chart to ensure responsiveness and clarity */
        #moodChart {
            max-width: 100%;
            height: auto;
            background-color: #0d1117;
            border-radius: 0.5rem;
        }
    </style>
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, setLogLevel, serverTimestamp, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase instances and variables
        let app;
        let db;
        let auth;
        let userId;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        setLogLevel('Debug');

        // --- Utility Functions ---

        /**
         * Simple Base64 decoding for ArrayBuffer required for PCM to WAV conversion.
         * @param {string} base64 The base64 string.
         * @returns {ArrayBuffer}
         */
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        /**
         * Implements exponential backoff for retrying failed API calls.
         * @param {Function} fn The function to retry (must return a Promise).
         * @param {number} maxRetries The maximum number of retries.
         * @param {number} delay The initial delay in milliseconds.
         * @returns {Promise<any>} The result of the successful function call.
         */
        async function exponentialBackoff(fn, maxRetries = 5, delay = 1000) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await fn();
                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw error;
                    }
                    console.warn(API call failed. Retrying in ${delay}ms..., error);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2; // Exponential increase
                }
            }
        }

        /**
         * Fetches a motivational quote using the Gemini API.
         * @returns {Promise<string>} A motivational quote string.
         */
        async function fetchMotivationalQuote() {
            const systemPrompt = "Act as a friendly, inspirational coach. Provide a single, short, uplifting motivational quote.";
            const userQuery = "Generate a motivational quote for the day.";
            const apiKey = "";
            const apiUrl = https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey};

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            const fetchFn = async () => {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(HTTP error! status: ${response.status});
                }

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "The journey of a thousand miles begins with a single step.";
                return text;
            };

            try {
                const quote = await exponentialBackoff(fetchFn);
                document.getElementById('quoteText').textContent = quote;
                document.getElementById('quoteLoader').classList.add('hidden');
                document.getElementById('quoteText').classList.remove('hidden');
            } catch (error) {
                console.error("Failed to fetch quote after retries:", error);
                document.getElementById('quoteText').textContent = "In the middle of difficulty lies opportunity.";
                document.getElementById('quoteLoader').classList.add('hidden');
                document.getElementById('quoteText').classList.remove('hidden');
            }
        }

        // --- Firestore Functions ---

        /**
         * Gets the Firestore collection reference for the user's mood entries.
         */
        function getMoodCollectionRef() {
            if (!db || !userId) {
                console.error("Firestore not initialized or userId missing.");
                return null;
            }
            // Private data path: /artifacts/{appId}/users/{userId}/mood_entries
            return collection(db, artifacts/${appId}/users/${userId}/mood_entries);
        }

        /**
         * Saves a new mood entry to Firestore.
         * @param {number} moodValue The mood rating (1-5).
         */
        window.saveMood = async function(moodValue) {
            if (!userId) {
                console.error("User not authenticated, cannot save mood.");
                showStatusMessage("Error: Please wait for authentication to complete.", true);
                return;
            }

            const moodCollectionRef = getMoodCollectionRef();
            if (!moodCollectionRef) return;

            try {
                const docRef = await addDoc(moodCollectionRef, {
                    mood: moodValue,
                    timestamp: serverTimestamp(),
                    dateKey: new Date().toISOString().split('T')[0] // Store only the date for easy uniqueness check
                });
                console.log("Mood document written with ID: ", docRef.id);
                showStatusMessage(Mood logged successfully! Rating: ${moodValue}, false);
            } catch (e) {
                console.error("Error adding document: ", e);
                showStatusMessage("Error logging mood. Check console.", true);
            }
        }

        let moodHistory = [];

        /**
         * Sets up a real-time listener for the user's mood history.
         */
        function setupMoodListener() {
            const moodCollectionRef = getMoodCollectionRef();
            if (!moodCollectionRef) return;

            // Query the last 30 days of entries, sorted by timestamp
            const q = query(moodCollectionRef, orderBy("timestamp", "desc"), limit(30));

            onSnapshot(q, (querySnapshot) => {
                const newHistory = [];
                querySnapshot.forEach((doc) => {
                    newHistory.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort chronologically for charting
                newHistory.sort((a, b) => (a.timestamp?.toMillis() || 0) - (b.timestamp?.toMillis() || 0));

                moodHistory = newHistory;
                console.log("Mood history updated:", moodHistory);
                renderHistoryList();
                renderChart(moodHistory);
            }, (error) => {
                console.error("Error setting up mood listener:", error);
                showStatusMessage("Failed to load mood history.", true);
            });
        }

        // --- UI Rendering and Chart Logic ---

        /**
         * Shows a temporary status message to the user.
         * @param {string} message The message content.
         * @param {boolean} isError If true, displays as an error.
         */
        function showStatusMessage(message, isError) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.classList.remove('hidden', 'bg-red-500', 'bg-green-500');
            statusDiv.classList.add(isError ? 'bg-red-500' : 'bg-green-500');
            setTimeout(() => {
                statusDiv.classList.add('hidden');
            }, 3000);
        }

        /**
         * Renders the history list below the form.
         */
        function renderHistoryList() {
            const listDiv = document.getElementById('historyList');
            if (moodHistory.length === 0) {
                listDiv.innerHTML = '<p class="text-gray-400 text-center p-4">No entries yet. Log your first mood!</p>';
                return;
            }

            const html = moodHistory.slice().reverse().map(entry => {
                const date = entry.timestamp ? new Date(entry.timestamp.toMillis()).toLocaleDateString() : 'N/A';
                const moodText = {
                    1: 'Terrible üò•',
                    2: 'Bad üôÅ',
                    3: 'Neutral üòê',
                    4: 'Good üôÇ',
                    5: 'Excellent üòÑ'
                }[entry.mood] || Rating: ${entry.mood};
                
                return `
                    <li class="flex justify-between items-center py-2 px-3 border-b border-gray-700 last:border-b-0 hover:bg-gray-800 rounded-md">
                        <span class="text-gray-300 font-medium">${date}</span>
                        <span class="text-white">${moodText}</span>
                    </li>
                `;
            }).join('');
            
            listDiv.innerHTML = <ul class="space-y-1">${html}</ul>;
        }

        /**
         * Renders the mood trend chart on the canvas.
         * @param {Array<Object>} history The array of mood entries.
         */
        function renderChart(history) {
            const canvas = document.getElementById('moodChart');
            const ctx = canvas.getContext('2d');
            
            // Set canvas size to be responsive to the container
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = 300;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (history.length < 2) {
                ctx.fillStyle = '#4b5563';
                ctx.font = '16px Inter';
                ctx.textAlign = 'center';
                ctx.fillText('Log at least 2 moods to see the trend.', canvas.width / 2, canvas.height / 2);
                return;
            }

            const minMood = 1;
            const maxMood = 5;
            const padding = 30;
            const chartWidth = canvas.width - 2 * padding;
            const chartHeight = canvas.height - 2 * padding;
            const dataLength = history.length;
            const stepX = chartWidth / (dataLength - 1);
            const moodRange = maxMood - minMood;

            // Draw Y-axis labels and horizontal grid lines
            ctx.strokeStyle = '#374151';
            ctx.fillStyle = '#9ca3af';
            ctx.font = '12px Inter';
            ctx.textAlign = 'right';
            for (let i = minMood; i <= maxMood; i++) {
                const y = padding + chartHeight - (i - minMood) / moodRange * chartHeight;
                // Grid lines
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(canvas.width - padding, y);
                ctx.stroke();
                // Labels
                ctx.fillText(i, padding - 5, y + 4);
            }
            
            // Draw X-axis (time) labels
            ctx.textAlign = 'center';
            const indicesToShow = [0, Math.floor(dataLength / 2), dataLength - 1].filter((v, i, a) => a.indexOf(v) === i);
            
            for (let i = 0; i < dataLength; i++) {
                if (indicesToShow.includes(i)) {
                    const x = padding + i * stepX;
                    const date = history[i].timestamp ? new Date(history[i].timestamp.toMillis()).toLocaleDateString() : '';
                    ctx.fillText(date, x, canvas.height - 5);
                }
            }


            // Draw the mood line graph
            ctx.beginPath();
            ctx.lineWidth = 3;
            ctx.strokeStyle = '#64ffda'; // Tailwind teal-300 / mint

            history.forEach((entry, i) => {
                const normalizedMood = Math.max(minMood, Math.min(maxMood, entry.mood || 3));
                // Convert mood value to Y-coordinate
                const y = padding + chartHeight - (normalizedMood - minMood) / moodRange * chartHeight;
                const x = padding + i * stepX;

                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }

                // Draw mood dots
                ctx.fillStyle = '#64ffda';
                ctx.beginPath();
                ctx.arc(x, y, 4, 0, Math.PI * 2, true);
                ctx.fill();
            });

            ctx.stroke();
        }

        // --- Mood Selection Logic ---

        let selectedMood = null;

        window.selectMood = function(moodValue) {
            selectedMood = moodValue;
            const buttons = document.querySelectorAll('.mood-btn');
            buttons.forEach(btn => btn.classList.remove('selected'));
            document.getElementById(mood-${moodValue}).classList.add('selected');
            document.getElementById('logMoodButton').disabled = false;
        }

        window.logSelectedMood = function() {
            if (selectedMood !== null) {
                saveMood(selectedMood);
                // Reset selection after logging
                const buttons = document.querySelectorAll('.mood-btn');
                buttons.forEach(btn => btn.classList.remove('selected'));
                document.getElementById('logMoodButton').disabled = true;
                selectedMood = null;
            } else {
                showStatusMessage("Please select a mood before logging.", true);
            }
        }

        // --- Initialization ---

        window.onload = function() {
            // 1. Fetch the motivational quote immediately
            fetchMotivationalQuote();

            // 2. Initialize Firebase and Authentication
            if (Object.keys(firebaseConfig).length === 0) {
                document.getElementById('firebaseStatus').textContent = 'Firebase Config Missing. Data persistence is disabled.';
                document.getElementById('firebaseStatus').classList.remove('hidden');
                // Render a dummy chart if no persistence is possible
                renderChart([]);
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Sign In Logic
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('userIdDisplay').textContent = User ID: ${userId};
                        document.getElementById('firebaseStatus').textContent = 'Signed in. Data is secure.';
                        document.getElementById('firebaseStatus').classList.remove('hidden');
                        
                        // 3. Setup real-time listener for mood history
                        setupMoodListener();
                    } else {
                        // Attempt silent sign-in
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Authentication failed:", error);
                            document.getElementById('firebaseStatus').textContent = 'Authentication failed. Data persistence is disabled.';
                            document.getElementById('firebaseStatus').classList.add('bg-red-700');
                        }
                    }
                });

                // Set up the resize listener for chart responsiveness
                window.addEventListener('resize', () => {
                    if (moodHistory.length > 0) {
                        renderChart(moodHistory);
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                document.getElementById('firebaseStatus').textContent = Firebase Init Error: ${error.message};
                document.getElementById('firebaseStatus').classList.remove('hidden');
            }
        }
    </script>
</head>
<body class="min-h-screen p-4 sm:p-8 text-gray-100">

    <div class="max-w-4xl mx-auto space-y-8">
        <!-- Header -->
        <header class="text-center">
            <h1 class="text-4xl font-extrabold text-teal-300">Mental Wellness Journal üß†</h1>
            <p class="text-gray-400 mt-1">Track your mood, visualize your journey, and stay inspired.</p>
        </header>

        <!-- Motivational Quote Section (Innovation) -->
        <div class="card p-5 rounded-xl shadow-2xl border border-gray-700">
            <h2 class="text-xl font-semibold mb-3 text-teal-300">Daily Inspiration ‚ú®</h2>
            <div id="quoteLoader" class="flex items-center space-x-2">
                <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-teal-300"></div>
                <span class="text-gray-400">Fetching wisdom...</span>
            </div>
            <p id="quoteText" class="text-lg italic text-gray-300 text-center hidden">
                <!-- Quote fetched by LLM will be inserted here -->
            </p>
        </div>

        <!-- Log Mood Form (Frontend) -->
        <div class="card p-6 rounded-xl shadow-2xl">
            <h2 class="text-2xl font-bold mb-5 text-gray-200">How are you feeling today?</h2>

            <div class="flex flex-wrap justify-around gap-4 mb-6">
                <!-- Mood 1: Terrible -->
                <button id="mood-1" onclick="selectMood(1)" class="mood-btn p-3 rounded-full bg-red-800 hover:bg-red-700 border-4 border-red-900 focus:outline-none" title="Terrible (1/5)">
                    <span class="text-4xl">üò•</span>
                </button>
                <!-- Mood 2: Bad -->
                <button id="mood-2" onclick="selectMood(2)" class="mood-btn p-3 rounded-full bg-orange-700 hover:bg-orange-600 border-4 border-orange-800 focus:outline-none" title="Bad (2/5)">
                    <span class="text-4xl">üôÅ</span>
                </button>
                <!-- Mood 3: Neutral -->
                <button id="mood-3" onclick="selectMood(3)" class="mood-btn p-3 rounded-full bg-yellow-600 hover:bg-yellow-500 border-4 border-yellow-700 focus:outline-none" title="Neutral (3/5)">
                    <span class="text-4xl">üòê</span>
                </button>
                <!-- Mood 4: Good -->
                <button id="mood-4" onclick="selectMood(4)" class="mood-btn p-3 rounded-full bg-green-700 hover:bg-green-600 border-4 border-green-800 focus:outline-none" title="Good (4/5)">
                    <span class="text-4xl">üôÇ</span>
                </button>
                <!-- Mood 5: Excellent -->
                <button id="mood-5" onclick="selectMood(5)" class="mood-btn p-3 rounded-full bg-teal-600 hover:bg-teal-500 border-4 border-teal-700 focus:outline-none" title="Excellent (5/5)">
                    <span class="text-4xl">üòÑ</span>
                </button>
            </div>

            <button id="logMoodButton" onclick="logSelectedMood()" disabled
                class="w-full py-3 mt-4 text-white font-bold rounded-lg shadow-md transition duration-200 bg-teal-500 hover:bg-teal-400 disabled:bg-gray-600 disabled:cursor-not-allowed">
                Log Mood
            </button>
            
            <!-- Status Message -->
            <div id="statusMessage" class="hidden mt-3 p-2 text-center rounded-lg text-sm text-white"></div>
        </div>

        <!-- Positivity Trend Chart (Frontend/Analysis) -->
        <div class="card p-6 rounded-xl shadow-2xl">
            <h2 class="text-2xl font-bold mb-4 text-gray-200">Positivity Trend (Last 30 Days)</h2>
            <div class="overflow-x-auto">
                <!-- Canvas for the chart. The width is set by JS based on container size. -->
                <canvas id="moodChart"></canvas>
            </div>
        </div>

        <!-- History List -->
        <div class="card p-6 rounded-xl shadow-2xl">
            <h2 class="text-2xl font-bold mb-4 text-gray-200">Recent Mood History</h2>
            <div id="historyList" class="max-h-60 overflow-y-auto">
                <p class="text-gray-400 text-center p-4">Loading history...</p>
            </div>
        </div>

        <!-- Footer/Metadata -->
        <div class="text-center text-xs text-gray-600 space-y-1 mt-6">
            <p id="firebaseStatus" class="p-1 rounded-md bg-green-900 hidden">Initializing Firebase...</p>
            <p id="userIdDisplay" class="truncate"></p>
        </div>
    </div>

</body>
</html>